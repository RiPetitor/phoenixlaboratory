---
title: Руководство по настройке AmneziaWG на Arch дистрибутивах.
sidebar_position: 1
---

# Руководство по настройке AmneziaWG на Arch дистрибутивах.

import Tabs from '@theme/Tabs';
import TabItem from '@theme/TabItem';
import CodeBlock from '@theme/CodeBlock';

## Введение

**AmneziaWG** — это форк WireGuard с дополнительными функциями обфускации, который помогает обходить блокировки. В этом руководстве мы пошагово установим и настроим AmneziaWG на CachyOS (основанном на Arch Linux).

:::info Системные требования
- CachyOS или любой дистрибутив на базе Arch Linux
- Права администратора (sudo)
- Стабильное интернет-соединение
:::

## Установка зависимостей

### Шаг 1: Установка заголовков ядра

Сначала определим версию ядра и установим соответствующие заголовки:

<CodeBlock language="bash">
{`# Проверяем версию ядра
uname -r

# Для CachyOS ядра
sudo pacman -S linux-cachyos-headers

# Для стандартного ядра Linux (если используется)
sudo pacman -S linux-headers`}
</CodeBlock>

### Шаг 2: Установка инструментов разработки

<CodeBlock language="bash">
{`# Устанавливаем необходимые инструменты
sudo pacman -S git base-devel make curl jq clang llvm lld dkms`}
</CodeBlock>

## Компиляция и установка модуля ядра

### Шаг 3: Клонирование репозитория

<CodeBlock language="bash">
{`cd ~
git clone https://github.com/amnezia-vpn/amneziawg-linux-kernel-module.git
cd amneziawg-linux-kernel-module/src`}
</CodeBlock>

### Шаг 4: Подготовка исходников ядра (для ядер ≥ 5.6)

:::warning Внимание
Этот шаг необходим только если версия вашего ядра ≥ 5.6
:::

<Tabs>
<TabItem value="auto" label="Автоматическая установка">

<CodeBlock language="bash">
{`# Определяем версию ядра автоматически
KERNEL_VERSION=$(uname -r | cut -d'-' -f1)
echo "Версия ядра: $KERNEL_VERSION"

# Скачиваем и распаковываем исходники
cd ~/Downloads
wget https://cdn.kernel.org/pub/linux/kernel/v5.x/linux-\${KERNEL_VERSION}.tar.xz
tar -xf linux-\${KERNEL_VERSION}.tar.xz

# Создаем символическую ссылку
ln -sf ~/Downloads/linux-\${KERNEL_VERSION} ~/amneziawg-linux-kernel-module/src/kernel`}
</CodeBlock>

</TabItem>
<TabItem value="manual" label="Ручная установка">

<CodeBlock language="bash">
{`# Замените VERSION на вашу версию ядра
cd ~/Downloads
wget https://cdn.kernel.org/pub/linux/kernel/v5.x/linux-VERSION.tar.xz
tar -xf linux-VERSION.tar.xz
ln -sf ~/Downloads/linux-VERSION ~/amneziawg-linux-kernel-module/src/kernel`}
</CodeBlock>

</TabItem>
</Tabs>

### Шаг 5: Компиляция модуля через DKMS

:::tip Рекомендация
Используйте DKMS для автоматической пересборки модуля при обновлении ядра
:::

<CodeBlock language="bash">
{`cd ~/amneziawg-linux-kernel-module/src

# Копируем исходники в директорию DKMS
sudo mkdir -p /usr/src/amneziawg-1.0.0
sudo cp -r . /usr/src/amneziawg-1.0.0/

# Создаем конфигурационный файл DKMS
sudo tee /usr/src/amneziawg-1.0.0/dkms.conf << EOF
PACKAGE_NAME="amneziawg"
PACKAGE_VERSION="1.0.0"
BUILT_MODULE_NAME[0]="amneziawg"
DEST_MODULE_LOCATION[0]="/kernel/net"
AUTOINSTALL="yes"
MAKE[0]="make LLVM=1"
EOF

# Устанавливаем модуль через DKMS
sudo dkms add -m amneziawg -v 1.0.0
sudo dkms build -m amneziawg -v 1.0.0
sudo dkms install -m amneziawg -v 1.0.0`}
</CodeBlock>

## Установка инструментов AmneziaWG

### Шаг 6: Компиляция awg-tools

<CodeBlock language="bash">
{`cd ~
git clone https://github.com/amnezia-vpn/amneziawg-tools.git
cd amneziawg-tools/src
make
sudo make install`}
</CodeBlock>

### Шаг 7: Перезагрузка системы

<CodeBlock language="bash">
{`sudo reboot`}
</CodeBlock>

## Настройка Cloudflare WARP (опционально)

:::note Примечание
Этот раздел применим только если вы хотите использовать бесплатный Cloudflare WARP
:::

### Шаг 8: Создание генератора конфига

<CodeBlock language="bash">
{`# Создаем скрипт генерации
touch ~/genconf.sh
chmod +x ~/genconf.sh
nano ~/genconf.sh`}
</CodeBlock>

Добавьте следующий код в файл:

<CodeBlock language="bash">
{`#!/bin/bash

priv="\${1:-$(awg genkey)}"
pub="\${2:-$(echo "\${priv}" | awg pubkey)}"
api="https://api.cloudflareclient.com/v0i1909051800"
ins() { curl -s -H 'user-agent:' -H 'content-type: application/json' -X "$1" "\${api}/$2" "\${@:3}"; }
sec() { ins "$1" "$2" -H "authorization: Bearer $3" "\${@:4}"; }
response=$(ins POST "reg" -d "{\\"install_id\\":\\"\\",\\"tos\\":\\"$(date -u +%FT%T.000Z)\\",\\"key\\":\\"\${pub}\\",\\"fcm_token\\":\\"\\",\\"type\\":\\"Android\\",\\"locale\\":\\"en_US\\"}")

id=$(echo "$response" | jq -r '.result.id')
token=$(echo "$response" | jq -r '.result.token')
response=$(sec PATCH "reg/\${id}" "$token" -d '{"warp_enabled":true}')
peer_pub=$(echo "$response" | jq -r '.result.config.peers[0].public_key')
peer_endpoint=$(echo "$response" | jq -r '.result.config.peers[0].endpoint.host')
client_ipv4=$(echo "$response" | jq -r '.result.config.interface.addresses.v4')
client_ipv6=$(echo "$response" | jq -r '.result.config.interface.addresses.v6')

conf=$(cat <<-EOM
[Interface]
PrivateKey = \${priv}
S1 = 0
S2 = 0
Jc = 120
Jmin = 23
Jmax = 911
H1 = 1
H2 = 2
H3 = 3
H4 = 4
MTU = 1280
Address = \${client_ipv4}, \${client_ipv6}
DNS = 1.1.1.1, 2606:4700:4700::1111, 1.0.0.1, 2606:4700:4700::1001

[Peer]
PublicKey = \${peer_pub}
AllowedIPs = 0.0.0.0/0, ::/0
Endpoint = \${peer_endpoint}
EOM
)

echo "$conf" > awg-client.conf`}
</CodeBlock>

### Шаг 9: Генерация и установка конфига

<CodeBlock language="bash">
{`# Генерируем конфиг
./genconf.sh

# Создаем директорию и перемещаем конфиг
sudo mkdir -p /etc/amnezia/amneziawg/
sudo mv awg-client.conf /etc/amnezia/amneziawg/awg-client.conf`}
</CodeBlock>

## Настройка сетевых служб

### Шаг 10: Установка сетевых инструментов

<CodeBlock language="bash">
{`# Устанавливаем resolvconf
sudo pacman -S openresolv

# Включаем systemd-resolved
sudo systemctl enable systemd-resolved.service
sudo systemctl start systemd-resolved.service`}
</CodeBlock>

## Управление AmneziaWG

### Базовые команды

| Команда | Описание |
|---------|----------|
| `sudo awg-quick up awg-client` | Подключиться к VPN |
| `sudo awg-quick down awg-client` | Отключиться от VPN |
| `sudo awg show` | Показать статус соединения |
| `sudo awg show awg-client` | Показать детали конкретного интерфейса |

### Автозапуск VPN

<Tabs>
<TabItem value="enable" label="Включить автозапуск">

<CodeBlock language="bash">
{`sudo systemctl enable awg-quick@awg-client
sudo systemctl start awg-quick@awg-client`}
</CodeBlock>

</TabItem>
<TabItem value="disable" label="Отключить автозапуск">

<CodeBlock language="bash">
{`sudo systemctl disable awg-quick@awg-client
sudo systemctl stop awg-quick@awg-client`}
</CodeBlock>

</TabItem>
</Tabs>
